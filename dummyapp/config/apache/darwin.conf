<VirtualHost *:80 *:8080>

    # so we can detect 82/446
    UseCanonicalPhysicalPort On

    ServerName      ui.awin.com

    DocumentRoot    /home/sites/darwin.affiliatewindow.com/web

    CustomLog /srv/log/darwin-docker/apache-darwin-access.log user-combined env=!dontlog
    ErrorLog /srv/log/darwin-docker/apache-darwin-error.log

    RewriteEngine   On

    # Detect whether this is an SSL request or not. SetEnvIf couldn't be done with this
    # but it appers this "hack" with mod_rewrite has access to the SERVER_PORT env var
    # The RewriteRule doesn't rewrite anywhere, just sets these ENV vars
    RewriteCond %{SERVER_PORT}  ^444$
    RewriteRule .*      -       [env=HTTPS:on]

    <Directory /home/sites/darwin.affiliatewindow.com/web>
        Allow from all
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} -s [OR]
        RewriteCond %{REQUEST_FILENAME} -l [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^.*$ - [NC,L]
        # bypass Darwin index for healthcheck, so it's much ligher
        RewriteRule ^zxmonitor/status\.txt$ zxmonitor/status.php [NC,L]
        RewriteRule ^.*$ index.php [NC,L]
    </Directory>

</VirtualHost>

<VirtualHost *:444>

    # so we can detect 82/446
    UseCanonicalPhysicalPort On

    ServerName      ui.awin.com

    DocumentRoot    /home/sites/darwin.affiliatewindow.com/web

    CustomLog /srv/log/darwin-docker/apache-darwin-ssl-access.log user-combined env=!dontlog
    ErrorLog /srv/log/darwin-docker/apache-darwin-ssl-error.log

    RewriteEngine   On

    # Detect whether this is an SSL request or not. SetEnvIf couldn't be done with this
    # but it appers this "hack" with mod_rewrite has access to the SERVER_PORT env var
    # The RewriteRule doesn't rewrite anywhere, just sets these ENV vars
    RewriteCond %{SERVER_PORT}  ^444$
    RewriteRule .*      -       [env=HTTPS:on]

    <Directory /home/sites/darwin.affiliatewindow.com/web>
        Allow from all
        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} -s [OR]
        RewriteCond %{REQUEST_FILENAME} -l [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^.*$ - [NC,L]
        # bypass Darwin index for healthcheck, so it's much ligher
        RewriteRule ^zxmonitor/status\.txt$ zxmonitor/status.php [NC,L]
        RewriteRule ^.*$ index.php [NC,L]
    </Directory>

</VirtualHost>
